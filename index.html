<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solid Chat</title>
  <meta name="description" content="Modern, decentralized chat app for Solid pods. Your messages, your control.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://solid-chat.com/app">
  <meta property="og:title" content="Solid Chat App">
  <meta property="og:description" content="Modern, decentralized chat app for Solid pods. Your messages, your control.">
  <meta property="og:image" content="https://solid-chat.com/og-image.png">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://solid-chat.com/app">
  <meta name="twitter:title" content="Solid Chat App">
  <meta name="twitter:description" content="Modern, decentralized chat app for Solid pods. Your messages, your control.">
  <meta name="twitter:image" content="https://solid-chat.com/og-image.png">

  <!-- Additional Meta -->
  <meta name="theme-color" content="#667eea">
  <link rel="canonical" href="https://solid-chat.com/app">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gradient-start: #667eea;
      --gradient-end: #9f7aea;
      --bg: #f7f8fc;
      --text: #2d3748;
      --text-muted: #a0aec0;
      --accent: #805ad5;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .app-header {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      padding: 20px 24px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .app-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .app-header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .controls {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0,0,0,0.04);
    }

    .controls label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text);
    }

    .input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .controls input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #f7f8fc;
    }

    .controls input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
    }

    .controls button {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
    }

    .controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .user-status {
      font-size: 14px;
      color: var(--text-muted);
    }

    .user-status strong {
      color: var(--accent);
    }

    #loginArea {
      display: flex;
      gap: 8px;
    }

    #loginArea button {
      padding: 8px 16px;
      font-size: 13px;
    }

    .quick-links {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    .quick-links-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .quick-link {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px 4px 4px 0;
      background: linear-gradient(135deg, #f0f2f8 0%, #e8eaf2 100%);
      color: var(--text);
      text-decoration: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
    }

    .quick-link:hover {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    #chatContainer {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(102, 126, 234, 0.15), 0 2px 8px rgba(0,0,0,0.06);
      min-height: 400px;
    }

    .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      color: var(--text-muted);
      text-align: center;
    }

    .placeholder-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .placeholder h2 {
      color: var(--text);
      margin-bottom: 8px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      background: #fff3f3;
      border: 1px solid #ffcdd2;
      color: #c62828;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
  </style>
</head>
<body>

<header class="app-header">
  <h1>Solid Chat</h1>
  <p>Decentralized messaging for the web</p>
</header>

<div class="container">
  <div class="controls">
    <label for="chatUri">Chat Resource URI</label>
    <div class="input-row">
      <input type="text" id="chatUri" placeholder="https://pod.example/chat/general.ttl" />
      <button id="loadBtn">Load Chat</button>
    </div>

    <div class="status-row">
      <div class="user-status">
        Status: <strong id="userStatus">Loading...</strong>
      </div>
      <div id="loginArea"></div>
    </div>

    <div class="quick-links">
      <div class="quick-links-label">Example chats:</div>
      <a class="quick-link" data-uri="https://solidos.solidcommunity.net/Team/SolidOs%20team%20chat/2022/02/09/chat.ttl">SolidOS Team Chat</a>
      <a class="quick-link" data-uri="./test/chat.ttl">Local Test Chat</a>
    </div>
  </div>

  <div id="chatContainer">
    <div class="placeholder" id="placeholder">
      <div class="placeholder-icon">üí¨</div>
      <h2>Welcome to Solid Chat</h2>
      <p>Enter a chat URI above to get started,<br>or click one of the example links.</p>
    </div>
  </div>
</div>

<!-- Load rdflib and Solid auth -->
<script src="https://cdn.jsdelivr.net/npm/rdflib@2.2.33/dist/rdflib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@inrupt/solid-client-authn-browser@2.2.6/dist/solid-client-authn.bundle.js"></script>

<script type="module">
import { longChatPane } from './src/longChatPane.js'

// Wait for libraries to be available
async function waitForLibraries() {
  return new Promise((resolve) => {
    const check = setInterval(() => {
      if (typeof $rdf !== 'undefined' && typeof solidClientAuthentication !== 'undefined') {
        clearInterval(check)
        resolve()
      }
    }, 50)
  })
}

await waitForLibraries()

// Get Solid auth functions
const { login, logout, handleIncomingRedirect, getDefaultSession } = solidClientAuthentication

// DOM elements
const chatUriInput = document.getElementById('chatUri')
const loadBtn = document.getElementById('loadBtn')
const chatContainer = document.getElementById('chatContainer')
const placeholder = document.getElementById('placeholder')
const userStatus = document.getElementById('userStatus')
const loginArea = document.getElementById('loginArea')

// Auth state
let currentSession = null
let currentWebId = null

// Handle redirect callback from IdP
async function handleAuthRedirect() {
  userStatus.textContent = 'Checking login...'

  try {
    await handleIncomingRedirect({ restorePreviousSession: true })
    currentSession = getDefaultSession()

    if (currentSession.info.isLoggedIn) {
      currentWebId = currentSession.info.webId
      updateAuthUI(true)
    } else {
      updateAuthUI(false)
    }
  } catch (err) {
    console.error('Auth redirect error:', err)
    updateAuthUI(false)
  }
}

// Update UI based on auth state
function updateAuthUI(isLoggedIn) {
  if (isLoggedIn && currentWebId) {
    const shortId = currentWebId.split('//')[1]?.split('/')[0] || currentWebId
    userStatus.innerHTML = `Logged in as <strong><a href="${currentWebId}" target="_blank" style="color: var(--accent); text-decoration: none;">${shortId}</a></strong>`
    loginArea.innerHTML = `<button id="logoutBtn">Logout</button>`
    document.getElementById('logoutBtn').addEventListener('click', handleLogout)
  } else {
    userStatus.textContent = 'Not logged in'
    loginArea.innerHTML = `
      <input type="text" id="idpInput" placeholder="solidcommunity.net" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; width: 160px;">
      <button id="loginBtn">Login</button>
    `
    document.getElementById('loginBtn').addEventListener('click', handleLogin)
    document.getElementById('idpInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleLogin()
    })
  }
}

// Handle login
async function handleLogin() {
  const idpInput = document.getElementById('idpInput')
  let idp = idpInput.value.trim() || 'solidcommunity.net'

  // Add https if missing
  if (!idp.startsWith('http')) {
    idp = 'https://' + idp
  }

  userStatus.textContent = 'Redirecting to login...'

  try {
    await login({
      oidcIssuer: idp,
      redirectUrl: window.location.href,
      clientName: 'Solid Chat'
    })
  } catch (err) {
    console.error('Login error:', err)
    userStatus.textContent = 'Login failed: ' + err.message
  }
}

// Handle logout
async function handleLogout() {
  try {
    await logout()
    currentSession = null
    currentWebId = null
    updateAuthUI(false)
  } catch (err) {
    console.error('Logout error:', err)
  }
}

// Get authenticated fetch function
function getAuthFetch() {
  if (currentSession?.info?.isLoggedIn) {
    return currentSession.fetch
  }
  return fetch.bind(window)
}

// Get globals from rdflib with authenticated fetch
const store = $rdf.graph()
const fetcher = new $rdf.Fetcher(store, { fetch: getAuthFetch() })
store.fetcher = fetcher
store.rdflib = $rdf

// Update fetcher when auth changes
function updateFetcher() {
  store.fetcher = new $rdf.Fetcher(store, { fetch: getAuthFetch() })
}

// Simple updater with authenticated fetch
store.updater = {
  update: async function(del, ins) {
    const doc = ins[0]?.why || del[0]?.why
    if (!doc) throw new Error('No document to update')

    // Serialize insertions as N3
    let body = ''
    for (const st of ins) {
      body += `${st.subject.toNT()} ${st.predicate.toNT()} ${st.object.toNT()} .\n`
    }

    const authFetch = getAuthFetch()
    const response = await authFetch(doc.value, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/sparql-update'
      },
      body: `INSERT DATA { ${body} }`
    })

    if (!response.ok) {
      throw new Error(`Failed to update: ${response.status}`)
    }

    // Update local store
    for (const st of ins) {
      store.add(st.subject, st.predicate, st.object, st.why)
    }
  }
}

// Create context for pane
function createContext(uri) {
  // Use real logged in user, or mock for local test
  const isLocalChat = uri.includes('test/chat.ttl') || uri.startsWith('./')
  let user = null

  if (currentWebId) {
    user = $rdf.sym(currentWebId)
  } else if (isLocalChat) {
    user = $rdf.sym('https://melvin.solid.social/profile/card#me')
  }

  // Update fetcher with current auth
  updateFetcher()

  return {
    dom: document,
    session: {
      store: store,
      logic: {
        authn: {
          currentUser: () => user
        }
      }
    }
  }
}

// Load chat function
async function loadChat(uri) {
  if (!uri) {
    alert('Please enter a chat URI')
    return
  }

  // Convert relative URIs to absolute
  if (uri.startsWith('./') || uri.startsWith('../') || !uri.includes('://')) {
    uri = new URL(uri, window.location.href).href
  }

  chatContainer.innerHTML = `
    <div class="placeholder">
      <div class="loading-spinner"></div>
      <p>Loading chat...</p>
    </div>
  `

  try {
    const subject = $rdf.sym(uri)
    const context = createContext(uri)

    // Clear container and render pane
    chatContainer.innerHTML = ''

    // Check if pane applies
    const label = longChatPane.label(subject, context)
    if (!label) {
      // Force render anyway for demo
      console.log('Pane label returned null, but rendering anyway for demo')
    }

    const element = longChatPane.render(subject, context)
    chatContainer.appendChild(element)

  } catch (err) {
    console.error('Error loading chat:', err)
    chatContainer.innerHTML = `
      <div class="placeholder">
        <div class="placeholder-icon">‚ùå</div>
        <h2>Error Loading Chat</h2>
        <p>${err.message}</p>
      </div>
    `
  }
}

// Event listeners
loadBtn.addEventListener('click', () => loadChat(chatUriInput.value.trim()))

chatUriInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') loadChat(chatUriInput.value.trim())
})

document.querySelectorAll('.quick-link').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault()
    const uri = link.dataset.uri
    chatUriInput.value = uri
    loadChat(uri)
  })
})

// Initialize: handle auth redirect first, then load chat
async function init() {
  // Handle auth redirect callback (if returning from IdP)
  await handleAuthRedirect()

  // Check for URI in query string, or load default
  const params = new URLSearchParams(window.location.search)
  const initialUri = params.get('uri') || 'https://solidos.solidcommunity.net/Team/SolidOs%20team%20chat/2022/02/09/chat.ttl'
  chatUriInput.value = initialUri
  loadChat(initialUri)
}

init()
</script>

</body>
</html>
